<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Figma MCP Bridge</title>
    <style>
      :root {
        --bg: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-tertiary: #ebebeb;
        --text: #111111;
        --text-muted: #666666;
        --border: #e0e0e0;
        --accent: #0d99ff;
        --accent-hover: #0b85e0;
        --success: #14ae5c;
        --error: #f24822;
        --warning: #ffb800;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #2c2c2c;
          --bg-secondary: #383838;
          --bg-tertiary: #444444;
          --text: #ffffff;
          --text-muted: #b3b3b3;
          --border: #444444;
        }
      }
      * { box-sizing: border-box; }
      body {
        font-family: "Inter", "SF Pro", -apple-system, sans-serif;
        font-size: 11px;
        margin: 0;
        padding: 12px;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
      }
      .header h1 {
        font-size: 13px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .version {
        font-size: 10px;
        color: var(--text-muted);
        font-weight: 400;
      }
      .ping {
        font-size: 9px;
        color: var(--text-muted);
        padding: 2px 6px;
        background: var(--bg-secondary);
        border-radius: 4px;
      }
      .ping.good { color: var(--success); }
      .ping.slow { color: var(--warning); }
      .ping.bad { color: var(--error); }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
        flex-shrink: 0;
      }
      .status-dot.connected { background: var(--success); }
      .status-dot.error { background: var(--error); }
      .status-dot.polling {
        background: var(--accent);
        animation: pulse 1.5s infinite;
      }
      .status-dot.connecting {
        background: var(--warning);
        animation: pulse 0.8s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .status-text {
        font-size: 10px;
        color: var(--text-muted);
        margin-left: 4px;
      }
      label {
        display: block;
        margin-top: 8px;
        font-weight: 500;
        color: var(--text-muted);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .input-row {
        display: flex;
        gap: 4px;
        margin-top: 4px;
      }
      input {
        flex: 1;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 11px;
        background: var(--bg-secondary);
        color: var(--text);
        outline: none;
      }
      input:focus { border-color: var(--accent); }
      input:disabled { opacity: 0.5; cursor: not-allowed; }
      .icon-btn {
        padding: 8px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
      }
      .icon-btn:hover { background: var(--bg-tertiary); color: var(--text); }
      .icon-btn:disabled { opacity: 0.3; cursor: not-allowed; }
      .btn-row {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      button {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      button:hover:not(:disabled) { opacity: 0.85; }
      button:active:not(:disabled) { opacity: 0.7; transform: scale(0.98); }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .btn-primary {
        background: var(--accent);
        color: #fff;
      }
      .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
      .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .btn-danger {
        background: var(--error);
        color: #fff;
      }
      .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      .stats {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding: 10px;
        background: var(--bg-secondary);
        border-radius: 6px;
      }
      .stat {
        text-align: center;
        flex: 1;
        position: relative;
      }
      .stat-value {
        font-size: 18px;
        font-weight: 600;
        color: var(--accent);
      }
      .stat-value.success { color: var(--success); }
      .stat-value.error { color: var(--error); }
      .stat-label {
        font-size: 9px;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-top: 2px;
      }
      .stat-sub {
        font-size: 8px;
        color: var(--text-muted);
        margin-top: 1px;
      }
      .section {
        margin-top: 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }
      .section-header {
        padding: 6px 10px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        font-weight: 500;
        font-size: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }
      .section-header:hover { background: var(--bg-tertiary); }
      .section-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .section-action {
        color: var(--text-muted);
        cursor: pointer;
        font-size: 10px;
      }
      .section-action:hover { color: var(--accent); }
      .section-content {
        max-height: 150px;
        overflow-y: auto;
        transition: max-height 0.2s;
      }
      .section-content.collapsed { max-height: 0; overflow: hidden; }
      .log-content {
        padding: 8px;
        font-family: "SF Mono", "Menlo", monospace;
        font-size: 10px;
      }
      .log-entry {
        padding: 4px 0;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }
      .log-entry:last-child { border-bottom: none; }
      .log-time { color: var(--text-muted); min-width: 50px; flex-shrink: 0; }
      .log-action { color: var(--accent); min-width: 100px; flex-shrink: 0; word-break: break-all; }
      .log-result { flex: 1; word-break: break-word; }
      .log-result.ok { color: var(--success); }
      .log-result.error { color: var(--error); }
      .log-filter {
        display: flex;
        gap: 4px;
      }
      .filter-btn {
        padding: 2px 6px;
        font-size: 9px;
        border-radius: 3px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        cursor: pointer;
      }
      .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
      .test-progress {
        margin-top: 8px;
        padding: 8px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 10px;
      }
      .progress-bar {
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        margin-top: 6px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: var(--accent);
        transition: width 0.3s;
      }
      .quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        padding: 8px;
      }
      .quick-btn {
        padding: 4px 8px;
        font-size: 9px;
        background: var(--bg-tertiary);
        border: none;
        border-radius: 4px;
        color: var(--text);
        cursor: pointer;
        flex: 0 0 auto;
      }
      .quick-btn:hover { background: var(--accent); color: #fff; }
      .tooltip {
        position: relative;
      }
      .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 4px 8px;
        background: var(--text);
        color: var(--bg);
        font-size: 9px;
        border-radius: 4px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s;
        margin-bottom: 4px;
      }
      .tooltip:hover::after { opacity: 1; }
      .session-info {
        display: flex;
        justify-content: space-between;
        padding: 6px 10px;
        background: var(--bg-secondary);
        border-radius: 6px;
        margin-top: 8px;
        font-size: 9px;
        color: var(--text-muted);
      }
      .kbd {
        padding: 1px 4px;
        background: var(--bg-tertiary);
        border-radius: 3px;
        font-size: 9px;
        font-family: "SF Mono", monospace;
      }
      .empty-state {
        color: var(--text-muted);
        text-align: center;
        padding: 20px;
      }
      .badge {
        display: inline-block;
        padding: 1px 5px;
        font-size: 9px;
        border-radius: 3px;
        background: var(--bg-tertiary);
        color: var(--text-muted);
        margin-left: 4px;
      }
      .badge.success { background: var(--success); color: #fff; }
      .badge.error { background: var(--error); color: #fff; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>
        <span class="status-dot" id="statusDot"></span>
        Figma MCP
        <span class="status-text" id="statusText">Disconnected</span>
      </h1>
      <div class="header-right">
        <span class="ping" id="pingDisplay" style="display:none;">--ms</span>
        <span class="version">v0.3.18 Â· 100 actions</span>
      </div>
    </div>

    <label for="server">Server URL <span class="kbd">Enter</span></label>
    <div class="input-row">
      <input id="server" value="http://localhost:8940" />
    </div>

    <label for="channel">Channel ID</label>
    <div class="input-row">
      <input id="channel" placeholder="Auto-generated on connect" />
      <button class="icon-btn tooltip" id="copyChannel" data-tooltip="Copy ID" disabled>ðŸ“‹</button>
    </div>

    <div class="btn-row">
      <button class="btn-primary" id="connect">
        <span id="connectText">Connect</span>
        <span class="spinner" id="connectSpinner" style="display:none;"></span>
      </button>
      <button class="btn-danger" id="disconnect" style="display:none;">Disconnect</button>
      <button class="btn-secondary tooltip" id="selfTest" data-tooltip="Run 10 diagnostic tests" disabled>Self-Test</button>
    </div>

    <div class="session-info" id="sessionInfo" style="display:none;">
      <span>Session: <span id="sessionDuration">0:00</span></span>
      <span>Rate: <span id="successRate">-</span></span>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="cmdCount">0</div>
        <div class="stat-label">Commands</div>
      </div>
      <div class="stat">
        <div class="stat-value success" id="okCount">0</div>
        <div class="stat-label">Success</div>
      </div>
      <div class="stat">
        <div class="stat-value error" id="errCount">0</div>
        <div class="stat-label">Errors</div>
      </div>
    </div>

    <div id="testProgress" class="test-progress" style="display:none;">
      <div>Testing: <span id="testName">-</span> <span id="testCount"></span></div>
      <div class="progress-bar"><div class="progress-fill" id="testBar" style="width:0%"></div></div>
    </div>

    <div class="section" id="quickActionsSection" style="display:none;">
      <div class="section-header">
        <span>Quick Actions</span>
        <span class="section-action" id="toggleQuick">â–¼</span>
      </div>
      <div class="section-content" id="quickContent">
        <div class="quick-actions">
          <button class="quick-btn" data-action="read_selection">Selection</button>
          <button class="quick-btn" data-action="list_pages">Pages</button>
          <button class="quick-btn" data-action="get_viewport">Viewport</button>
          <button class="quick-btn" data-action="get_doc_info">Doc Info</button>
          <button class="quick-btn" data-action="list_components">Components</button>
          <button class="quick-btn" data-action="get_local_styles">Styles</button>
          <button class="quick-btn" data-action="get_fonts">Fonts</button>
          <button class="quick-btn" data-action="get_layer_list">Layers</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header" id="logHeader">
        <span>Activity Log <span class="badge" id="logBadge">0</span></span>
        <div class="section-actions">
          <div class="log-filter">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="ok">OK</button>
            <button class="filter-btn" data-filter="err">Err</button>
          </div>
          <span class="section-action" id="exportLogs" title="Export logs">â†—</span>
          <span class="section-action" id="logClear" title="Clear logs">âœ•</span>
          <span class="section-action" id="toggleLog">â–¼</span>
        </div>
      </div>
      <div class="section-content" id="logContentWrapper">
        <div class="log-content" id="logContent">
          <div class="empty-state">Waiting for connection...</div>
        </div>
      </div>
    </div>

    <script>
      var serverInput = document.getElementById("server");
      var channelInput = document.getElementById("channel");
      var copyChannelBtn = document.getElementById("copyChannel");
      var connectBtn = document.getElementById("connect");
      var connectText = document.getElementById("connectText");
      var connectSpinner = document.getElementById("connectSpinner");
      var disconnectBtn = document.getElementById("disconnect");
      var selfTestBtn = document.getElementById("selfTest");
      var statusDot = document.getElementById("statusDot");
      var statusText = document.getElementById("statusText");
      var pingDisplay = document.getElementById("pingDisplay");
      var cmdCount = document.getElementById("cmdCount");
      var okCount = document.getElementById("okCount");
      var errCount = document.getElementById("errCount");
      var logContent = document.getElementById("logContent");
      var logContentWrapper = document.getElementById("logContentWrapper");
      var logClear = document.getElementById("logClear");
      var logBadge = document.getElementById("logBadge");
      var exportLogs = document.getElementById("exportLogs");
      var toggleLog = document.getElementById("toggleLog");
      var testProgress = document.getElementById("testProgress");
      var testName = document.getElementById("testName");
      var testCount = document.getElementById("testCount");
      var testBar = document.getElementById("testBar");
      var sessionInfo = document.getElementById("sessionInfo");
      var sessionDuration = document.getElementById("sessionDuration");
      var successRate = document.getElementById("successRate");
      var quickActionsSection = document.getElementById("quickActionsSection");
      var quickContent = document.getElementById("quickContent");
      var toggleQuick = document.getElementById("toggleQuick");

      var STORAGE_KEY = "figmaMcpBridgeState";
      var serverUrl = "";
      var channelId = "";
      var polling = false;
      var stats = { cmd: 0, ok: 0, err: 0 };
      var logs = [];
      var MAX_LOGS = 100;
      var sessionStart = null;
      var sessionTimer = null;
      var currentFilter = "all";
      var lastPing = null;
      var reconnectAttempts = 0;
      var MAX_RECONNECT = 5;

      function normalizeServerUrl(raw) {
        if (!raw) return "";
        var value = raw.trim();
        if (!value) return "";
        if (!/^https?:\/\//i.test(value)) value = "http://" + value;
        if (value.charAt(value.length - 1) === "/") value = value.slice(0, -1);
        return value;
      }

      function loadState() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch (e) { return null; }
      }

      function saveState(state) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
      }

      function setStatus(status, text) {
        statusDot.className = "status-dot " + status;
        statusText.textContent = text || status.charAt(0).toUpperCase() + status.slice(1);
      }

      function updateStats() {
        cmdCount.textContent = stats.cmd;
        okCount.textContent = stats.ok;
        errCount.textContent = stats.err;
        var total = stats.ok + stats.err;
        if (total > 0) {
          var rate = Math.round((stats.ok / total) * 100);
          successRate.textContent = rate + "%";
          successRate.style.color = rate >= 90 ? "var(--success)" : rate >= 70 ? "var(--warning)" : "var(--error)";
        }
      }

      function updateSessionDuration() {
        if (!sessionStart) return;
        var elapsed = Math.floor((Date.now() - sessionStart) / 1000);
        var mins = Math.floor(elapsed / 60);
        var secs = elapsed % 60;
        sessionDuration.textContent = mins + ":" + String(secs).padStart(2, "0");
      }

      function updatePing(ms) {
        lastPing = ms;
        pingDisplay.style.display = "inline";
        pingDisplay.textContent = ms + "ms";
        pingDisplay.className = "ping " + (ms < 100 ? "good" : ms < 500 ? "slow" : "bad");
      }

      function addLog(action, result, isOk) {
        var now = new Date();
        var time = String(now.getHours()).padStart(2, "0") + ":" +
                   String(now.getMinutes()).padStart(2, "0") + ":" +
                   String(now.getSeconds()).padStart(2, "0");
        logs.unshift({ time: time, action: action, result: result, ok: isOk });
        if (logs.length > MAX_LOGS) logs.pop();
        logBadge.textContent = logs.length;
        renderLogs();
      }

      function renderLogs() {
        var filtered = logs;
        if (currentFilter === "ok") filtered = logs.filter(function(l) { return l.ok; });
        else if (currentFilter === "err") filtered = logs.filter(function(l) { return !l.ok; });

        if (filtered.length === 0) {
          logContent.innerHTML = '<div class="empty-state">' +
            (logs.length === 0 ? "No activity yet" : "No matching logs") + '</div>';
          return;
        }
        var html = "";
        for (var i = 0; i < filtered.length; i++) {
          var log = filtered[i];
          var resultClass = log.ok ? "ok" : "error";
          var truncatedResult = log.result.length > 50 ? log.result.substring(0, 47) + "..." : log.result;
          html += '<div class="log-entry">' +
            '<span class="log-time">' + log.time + '</span>' +
            '<span class="log-action">' + log.action + '</span>' +
            '<span class="log-result ' + resultClass + '" title="' + escapeHtml(log.result) + '">' + escapeHtml(truncatedResult) + '</span>' +
          '</div>';
        }
        logContent.innerHTML = html;
      }

      function escapeHtml(str) {
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
      }

      function setConnected(connected) {
        connectBtn.style.display = connected ? "none" : "flex";
        disconnectBtn.style.display = connected ? "flex" : "none";
        selfTestBtn.disabled = !connected;
        copyChannelBtn.disabled = !connected;
        serverInput.disabled = connected;
        channelInput.disabled = connected;
        quickActionsSection.style.display = connected ? "block" : "none";
        sessionInfo.style.display = connected ? "flex" : "none";

        if (connected) {
          sessionStart = Date.now();
          sessionTimer = setInterval(updateSessionDuration, 1000);
        } else {
          if (sessionTimer) clearInterval(sessionTimer);
          sessionTimer = null;
          sessionStart = null;
          pingDisplay.style.display = "none";
        }
      }

      function setConnecting(connecting) {
        connectText.textContent = connecting ? "Connecting" : "Connect";
        connectSpinner.style.display = connecting ? "inline-block" : "none";
        connectBtn.disabled = connecting;
      }

      logClear.onclick = function(e) {
        e.stopPropagation();
        logs = [];
        logBadge.textContent = "0";
        renderLogs();
      };

      exportLogs.onclick = function(e) {
        e.stopPropagation();
        var data = logs.map(function(l) {
          return l.time + " | " + l.action + " | " + (l.ok ? "OK" : "ERR") + " | " + l.result;
        }).join("\n");
        var blob = new Blob([data], { type: "text/plain" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "figma-mcp-logs-" + new Date().toISOString().slice(0, 10) + ".txt";
        a.click();
        URL.revokeObjectURL(url);
        addLog("export", "Logs exported", true);
      };

      toggleLog.onclick = function(e) {
        e.stopPropagation();
        logContentWrapper.classList.toggle("collapsed");
        toggleLog.textContent = logContentWrapper.classList.contains("collapsed") ? "â–¶" : "â–¼";
      };

      toggleQuick.onclick = function(e) {
        e.stopPropagation();
        quickContent.classList.toggle("collapsed");
        toggleQuick.textContent = quickContent.classList.contains("collapsed") ? "â–¶" : "â–¼";
      };

      document.querySelectorAll(".filter-btn").forEach(function(btn) {
        btn.onclick = function(e) {
          e.stopPropagation();
          document.querySelectorAll(".filter-btn").forEach(function(b) { b.classList.remove("active"); });
          btn.classList.add("active");
          currentFilter = btn.getAttribute("data-filter");
          renderLogs();
        };
      });

      document.querySelectorAll(".quick-btn").forEach(function(btn) {
        btn.onclick = function() {
          var action = btn.getAttribute("data-action");
          if (!channelId) return;
          var cmd = { id: "quick-" + Date.now(), name: action, payload: {} };
          parent.postMessage({ pluginMessage: { type: "command", command: cmd } }, "*");
          addLog(action, "executing...", true);
          stats.cmd++;
          updateStats();
        };
      });

      copyChannelBtn.onclick = function() {
        if (!channelId) return;
        navigator.clipboard.writeText(channelId).then(function() {
          addLog("copy", "Channel ID copied", true);
        });
      };

      var state = loadState();
      if (state && state.serverUrl) serverInput.value = state.serverUrl;
      if (state && state.channelId) channelInput.value = state.channelId;

      function connect() {
        serverUrl = normalizeServerUrl(serverInput.value);
        channelId = channelInput.value.trim();
        if (!serverUrl) {
          addLog("connect", "Server URL required", false);
          setStatus("error", "URL Required");
          return Promise.reject(new Error("Server URL required"));
        }
        serverInput.value = serverUrl;
        setStatus("connecting", "Connecting...");
        setConnecting(true);

        var startTime = Date.now();
        var payload = channelId ? { channel_id: channelId } : {};
        return fetch(serverUrl + "/plugin/connect", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }).then(function(resp) {
          updatePing(Date.now() - startTime);
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          return resp.json();
        }).then(function(data) {
          channelId = data.channel_id || channelId;
          channelInput.value = channelId;
          saveState({ serverUrl: serverUrl, channelId: channelId });
          setStatus("connected", "Connected");
          setConnected(true);
          setConnecting(false);
          reconnectAttempts = 0;
          addLog("connect", "Channel: " + channelId.slice(0, 8) + "...", true);
          if (!polling) {
            polling = true;
            pollLoop();
          }
        }).catch(function(err) {
          setStatus("error", "Connection Failed");
          setConnecting(false);
          addLog("connect", String(err), false);
          throw err;
        });
      }

      function disconnect() {
        polling = false;
        channelId = "";
        setStatus("", "Disconnected");
        setConnected(false);
        addLog("disconnect", "Disconnected by user", true);
      }

      function pollLoop() {
        if (!channelId || !polling) { polling = false; return; }
        setStatus("polling", "Listening...");
        var startTime = Date.now();
        fetch(serverUrl + "/plugin/poll", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ channel_id: channelId, max_commands: 5, wait_ms: 15000 })
        }).then(function(resp) {
          updatePing(Date.now() - startTime);
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          return resp.json();
        }).then(function(data) {
          setStatus("connected", "Connected");
          reconnectAttempts = 0;
          var commands = Array.isArray(data.commands) ? data.commands : [];
          for (var i = 0; i < commands.length; i++) {
            var cmd = commands[i];
            stats.cmd++;
            updateStats();
            addLog(cmd.name || "unknown", "executing...", true);
            parent.postMessage({ pluginMessage: { type: "command", command: cmd } }, "*");
          }
          if (polling) setTimeout(pollLoop, 50);
        }).catch(function(err) {
          reconnectAttempts++;
          var delay = Math.min(2000 * reconnectAttempts, 10000);
          setStatus("error", "Retry in " + (delay / 1000) + "s (" + reconnectAttempts + "/" + MAX_RECONNECT + ")");
          addLog("poll", String(err), false);
          if (reconnectAttempts >= MAX_RECONNECT) {
            polling = false;
            setStatus("error", "Max retries reached");
            setConnected(false);
            addLog("disconnect", "Connection lost after " + MAX_RECONNECT + " retries", false);
          } else if (polling) {
            setTimeout(pollLoop, delay);
          }
        });
      }

      window.onmessage = function(event) {
        var msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "command_result") {
          if (!channelId) return;
          var payload = msg.payload;
          if (typeof msg.payload_json === "string") {
            try { payload = JSON.parse(msg.payload_json); }
            catch (e) { payload = { error: "Parse error" }; }
          }
          if (msg.ok) { stats.ok++; } else { stats.err++; }
          updateStats();
          var resultText = msg.ok ? "OK" : (payload && payload.error ? payload.error : "Error");
          addLog(msg.action || "result", resultText, msg.ok);

          fetch(serverUrl + "/plugin/result", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              channel_id: channelId,
              command_id: msg.command_id,
              ok: msg.ok,
              payload: payload
            })
          });
        }

        if (msg.type === "test_result") {
          var ok = msg.ok;
          if (ok) { stats.ok++; } else { stats.err++; }
          updateStats();
          addLog("test:" + msg.action, ok ? "PASS" : "FAIL", ok);
        }
      };

      connectBtn.onclick = function() { connect().catch(function(){}); };
      disconnectBtn.onclick = disconnect;

      serverInput.onkeydown = function(e) {
        if (e.key === "Enter" && !connectBtn.disabled) {
          connect().catch(function(){});
        }
      };

      var SELF_TESTS = [
        { name: "list_pages", payload: {} },
        { name: "get_viewport", payload: {} },
        { name: "read_selection", payload: {} },
        { name: "get_doc_info", payload: {} },
        { name: "list_components", payload: {} },
        { name: "find_all", payload: { type: "FRAME" } },
        { name: "get_local_styles", payload: {} },
        { name: "get_fonts", payload: {} },
        { name: "get_layer_list", payload: {} },
        { name: "get_selection_colors", payload: {} }
      ];

      selfTestBtn.onclick = function() {
        if (!channelId) {
          addLog("self-test", "Connect first!", false);
          return;
        }
        selfTestBtn.disabled = true;
        testProgress.style.display = "block";
        runSelfTests(0);
      };

      function runSelfTests(idx) {
        if (idx >= SELF_TESTS.length) {
          testProgress.style.display = "none";
          selfTestBtn.disabled = false;
          addLog("self-test", "Completed " + SELF_TESTS.length + "/" + SELF_TESTS.length + " tests", true);
          return;
        }
        var test = SELF_TESTS[idx];
        testName.textContent = test.name;
        testCount.textContent = "(" + (idx + 1) + "/" + SELF_TESTS.length + ")";
        testBar.style.width = ((idx + 1) / SELF_TESTS.length * 100) + "%";

        var cmd = {
          id: "test-" + Date.now() + "-" + idx,
          name: test.name,
          payload: test.payload
        };
        parent.postMessage({ pluginMessage: { type: "command", command: cmd } }, "*");
        setTimeout(function() { runSelfTests(idx + 1); }, 300);
      }
    </script>
  </body>
</html>
