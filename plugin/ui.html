<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Figma MCP Bridge</title>
    <style>
      :root {
        --bg: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-tertiary: #ebebeb;
        --text: #111111;
        --text-muted: #666666;
        --border: #e0e0e0;
        --accent: #0d99ff;
        --accent-hover: #0b85e0;
        --success: #14ae5c;
        --error: #f24822;
        --warning: #ffb800;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #2c2c2c;
          --bg-secondary: #383838;
          --bg-tertiary: #444444;
          --text: #ffffff;
          --text-muted: #b3b3b3;
          --border: #444444;
        }
      }
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body {
        font-family: "Inter", "SF Pro", -apple-system, sans-serif;
        font-size: 11px;
        background: var(--bg);
        color: var(--text);
        overflow-x: hidden;
      }
      .container {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
      }
      .header h1 {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .version { font-size: 10px; color: var(--text-muted); }
      .ping {
        font-size: 9px;
        color: var(--text-muted);
        padding: 2px 6px;
        background: var(--bg-secondary);
        border-radius: 4px;
      }
      .ping.good { color: var(--success); }
      .ping.slow { color: var(--warning); }
      .ping.bad { color: var(--error); }
      .status-dot {
        width: 8px; height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
        flex-shrink: 0;
      }
      .status-dot.connected { background: var(--success); }
      .status-dot.error { background: var(--error); }
      .status-dot.polling { background: var(--accent); animation: pulse 1.5s infinite; }
      .status-dot.connecting { background: var(--warning); animation: pulse 0.8s infinite; }
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
      @keyframes spin { to { transform: rotate(360deg); } }
      .status-text { font-size: 10px; color: var(--text-muted); margin-left: 4px; }

      label {
        display: block;
        font-weight: 500;
        color: var(--text-muted);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }
      .input-row { display: flex; gap: 4px; }
      input, select {
        flex: 1;
        padding: 7px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 11px;
        background: var(--bg-secondary);
        color: var(--text);
        outline: none;
      }
      input:focus, select:focus { border-color: var(--accent); }
      input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }

      .icon-btn {
        padding: 7px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 30px;
      }
      .icon-btn:hover:not(:disabled) { background: var(--bg-tertiary); color: var(--text); }
      .icon-btn:disabled { opacity: 0.3; cursor: not-allowed; }

      .btn-row { display: flex; gap: 6px; }
      button {
        flex: 1;
        padding: 7px 10px;
        border: none;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      button:hover:not(:disabled) { opacity: 0.85; }
      button:active:not(:disabled) { transform: scale(0.98); }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .btn-primary { background: var(--accent); color: #fff; }
      .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
      .btn-secondary { background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); }
      .btn-danger { background: var(--error); color: #fff; }
      .btn-sm { padding: 4px 8px; font-size: 9px; flex: 0 0 auto; }
      .spinner { width: 12px; height: 12px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; }

      .stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        padding: 8px;
        background: var(--bg-secondary);
        border-radius: 6px;
      }
      .stat { text-align: center; }
      .stat-value { font-size: 16px; font-weight: 600; color: var(--accent); }
      .stat-value.success { color: var(--success); }
      .stat-value.error { color: var(--error); }
      .stat-label { font-size: 8px; color: var(--text-muted); text-transform: uppercase; }

      .section {
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }
      .section-header {
        padding: 6px 10px;
        background: var(--bg-secondary);
        font-weight: 500;
        font-size: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }
      .section-header:hover { background: var(--bg-tertiary); }
      .section-left { display: flex; align-items: center; gap: 6px; }
      .section-actions { display: flex; gap: 6px; align-items: center; }
      .section-action { color: var(--text-muted); cursor: pointer; font-size: 10px; }
      .section-action:hover { color: var(--accent); }
      .section-content { max-height: 120px; overflow-y: auto; transition: max-height 0.2s; }
      .section-content.collapsed { max-height: 0; overflow: hidden; }

      .log-content, .inspector-content, .history-content {
        padding: 6px;
        font-family: "SF Mono", "Menlo", monospace;
        font-size: 10px;
      }
      .log-entry, .history-entry {
        padding: 3px 0;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 6px;
        align-items: flex-start;
      }
      .log-entry:last-child, .history-entry:last-child { border-bottom: none; }
      .log-time { color: var(--text-muted); min-width: 45px; flex-shrink: 0; }
      .log-action { color: var(--accent); min-width: 80px; flex-shrink: 0; }
      .log-result { flex: 1; word-break: break-word; }
      .log-result.ok { color: var(--success); }
      .log-result.error { color: var(--error); }

      .quick-actions { display: flex; flex-wrap: wrap; gap: 4px; padding: 6px; }
      .quick-btn {
        padding: 4px 8px;
        font-size: 9px;
        background: var(--bg-tertiary);
        border: none;
        border-radius: 4px;
        color: var(--text);
        cursor: pointer;
      }
      .quick-btn:hover { background: var(--accent); color: #fff; }

      .filter-btns { display: flex; gap: 3px; }
      .filter-btn {
        padding: 2px 5px;
        font-size: 8px;
        border-radius: 3px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        cursor: pointer;
      }
      .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

      .toggle-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 10px;
      }
      .toggle {
        width: 32px; height: 18px;
        background: var(--border);
        border-radius: 9px;
        position: relative;
        cursor: pointer;
        transition: background 0.2s;
      }
      .toggle.on { background: var(--success); }
      .toggle::after {
        content: "";
        position: absolute;
        width: 14px; height: 14px;
        background: #fff;
        border-radius: 50%;
        top: 2px; left: 2px;
        transition: left 0.2s;
      }
      .toggle.on::after { left: 16px; }

      .inspector-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        border-bottom: 1px solid var(--border);
      }
      .inspector-row:last-child { border-bottom: none; }
      .inspector-key { color: var(--text-muted); }
      .inspector-value { color: var(--text); font-weight: 500; max-width: 180px; overflow: hidden; text-overflow: ellipsis; }

      .token-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 4px;
        padding: 6px;
      }
      .token-swatch {
        width: 100%; aspect-ratio: 1;
        border-radius: 4px;
        cursor: pointer;
        position: relative;
        border: 1px solid var(--border);
      }
      .token-swatch:hover::after {
        content: attr(data-color);
        position: absolute;
        bottom: -18px; left: 50%;
        transform: translateX(-50%);
        font-size: 8px;
        background: var(--text);
        color: var(--bg);
        padding: 2px 4px;
        border-radius: 2px;
        white-space: nowrap;
        z-index: 10;
      }

      .empty-state { color: var(--text-muted); text-align: center; padding: 15px; font-size: 10px; }

      .insights-header {
        padding: 6px;
        background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
        color: #fff;
        font-size: 10px;
        font-weight: 600;
      }
      .insights-content {
        padding: 8px;
        font-size: 10px;
        line-height: 1.5;
        background: var(--bg-tertiary);
      }
      .insight-item {
        padding: 4px 0;
        display: flex;
        align-items: flex-start;
        gap: 6px;
      }
      .insight-icon { flex-shrink: 0; }
      .insight-text { flex: 1; }
      .insight-pass { color: var(--success); }
      .insight-warn { color: var(--warning); }
      .insight-fail { color: var(--error); }
      .insight-info { color: var(--accent); }

      /* Code Generation Panel */
      .codegen-header {
        padding: 6px 8px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
        font-size: 10px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .platform-select {
        font-size: 9px;
        padding: 2px 4px;
        border: none;
        border-radius: 3px;
        background: rgba(255,255,255,0.2);
        color: #fff;
        cursor: pointer;
      }
      .platform-select option { color: #000; }
      .codegen-content { padding: 8px; background: var(--bg-tertiary); }
      .codegen-status {
        font-size: 9px;
        color: var(--text-secondary);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .codegen-status.streaming::before {
        content: "";
        width: 6px; height: 6px;
        background: var(--success);
        border-radius: 50%;
        animation: pulse 1s infinite;
      }
      @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
      .codegen-output {
        font-family: "SF Mono", Monaco, monospace;
        font-size: 10px;
        line-height: 1.4;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 8px;
        max-height: 200px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-all;
        margin: 0;
      }
      .codegen-output:empty::before {
        content: "// Code will appear here...";
        color: var(--text-secondary);
      }
      .codegen-actions {
        margin-top: 6px;
        display: flex;
        gap: 6px;
      }
      .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: #fff !important;
      }
      .btn-primary:hover:not(:disabled) { filter: brightness(1.1); }
      .btn-primary:disabled { opacity: 0.5; }
      .insight-info { color: var(--accent); }
      .analyzing {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        color: var(--text-muted);
      }

      .badge {
        display: inline-block;
        padding: 1px 5px;
        font-size: 8px;
        border-radius: 3px;
        background: var(--bg-tertiary);
        color: var(--text-muted);
      }
      .kbd { padding: 1px 4px; background: var(--bg-tertiary); border-radius: 3px; font-size: 9px; font-family: "SF Mono", monospace; }

      .test-progress {
        padding: 6px 10px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 10px;
      }
      .progress-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 4px; overflow: hidden; }
      .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }

      .session-bar {
        display: flex;
        justify-content: space-between;
        padding: 4px 10px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 9px;
        color: var(--text-muted);
      }

      .tabs { display: flex; gap: 2px; margin-bottom: 6px; }
      .tab {
        padding: 4px 8px;
        font-size: 9px;
        background: var(--bg-secondary);
        border: none;
        border-radius: 4px 4px 0 0;
        color: var(--text-muted);
        cursor: pointer;
      }
      .tab.active { background: var(--accent); color: #fff; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <span class="status-dot" id="statusDot"></span>
          Figma MCP
          <span class="status-text" id="statusText">Disconnected</span>
        </h1>
        <div class="header-right">
          <span class="ping" id="pingDisplay" style="display:none;">--ms</span>
          <span class="version">v0.3.18</span>
        </div>
      </div>

      <div>
        <label>Server URL <span class="kbd">‚Üµ</span></label>
        <div class="input-row">
          <input id="server" value="http://localhost:8940" />
        </div>
      </div>

      <div>
        <label>Channel ID</label>
        <div class="input-row">
          <input id="channel" placeholder="Auto-generated" />
          <button class="icon-btn" id="copyChannel" disabled title="Copy">üìã</button>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="connect">
          <span id="connectText">Connect</span>
          <span class="spinner" id="connectSpinner" style="display:none;"></span>
        </button>
        <button class="btn-danger" id="disconnect" style="display:none;">Disconnect</button>
        <button class="btn-secondary" id="selfTest" disabled>Test</button>
      </div>

      <div class="toggle-row">
        <span>Auto-reconnect</span>
        <div class="toggle on" id="autoReconnect"></div>
      </div>

      <div class="session-bar" id="sessionBar" style="display:none;">
        <span>‚è± <span id="sessionDuration">0:00</span></span>
        <span>üìä <span id="successRate">-</span></span>
        <span>üîÑ <span id="cmdPerMin">0</span>/min</span>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="cmdCount">0</div>
          <div class="stat-label">Cmds</div>
        </div>
        <div class="stat">
          <div class="stat-value success" id="okCount">0</div>
          <div class="stat-label">OK</div>
        </div>
        <div class="stat">
          <div class="stat-value error" id="errCount">0</div>
          <div class="stat-label">Err</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avgPing">-</div>
          <div class="stat-label">Ping</div>
        </div>
      </div>

      <div id="testProgress" class="test-progress" style="display:none;">
        <span>Testing: <span id="testName">-</span> <span id="testCount"></span></span>
        <div class="progress-bar"><div class="progress-fill" id="testBar"></div></div>
      </div>

      <!-- Selection Inspector -->
      <div class="section" id="inspectorSection">
        <div class="section-header" id="inspectorHeader">
          <span class="section-left">
            <span>üîç Selection</span>
            <span class="badge" id="selectionCount">0</span>
          </span>
          <div class="section-actions">
            <button class="btn-sm btn-secondary" id="analyzeBtn" disabled>üß† Analyze</button>
            <button class="btn-sm btn-primary" id="implementBtn" disabled>üöÄ Implement</button>
            <span class="section-action" id="toggleInspector">‚ñº</span>
          </div>
        </div>
        <div class="section-content" id="inspectorContent">
          <div class="inspector-content" id="inspectorData">
            <div class="empty-state">Select something in Figma</div>
          </div>
          <div id="insightsPanel" style="display:none;">
            <div class="insights-header">üí° AI Insights</div>
            <div class="insights-content" id="insightsData"></div>
          </div>
          <!-- Code Generation Panel -->
          <div id="codegenPanel" style="display:none;">
            <div class="codegen-header">
              <span>üöÄ Code Generation</span>
              <select id="platformSelect" class="platform-select">
                <option value="react">React/TSX</option>
                <option value="swiftui">SwiftUI</option>
                <option value="compose">Jetpack Compose</option>
                <option value="flutter">Flutter/Dart</option>
                <option value="html">HTML/CSS</option>
              </select>
            </div>
            <div class="codegen-content">
              <div class="codegen-status" id="codegenStatus">Ready</div>
              <pre class="codegen-output" id="codegenOutput"></pre>
              <div class="codegen-actions">
                <button class="btn-sm btn-secondary" id="copyCodeBtn" disabled>üìã Copy</button>
                <button class="btn-sm btn-primary" id="applyToFigmaBtn" disabled>üé® Apply to Figma</button>
                <button class="btn-sm btn-secondary" id="stopGenBtn" style="display:none;">‚èπ Stop</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="section" id="quickSection" style="display:none;">
        <div class="section-header">
          <span>‚ö° Quick Actions</span>
          <span class="section-action" id="toggleQuick">‚ñº</span>
        </div>
        <div class="section-content" id="quickContent">
          <div class="quick-actions">
            <button class="quick-btn" data-action="read_selection">Selection</button>
            <button class="quick-btn" data-action="list_pages">Pages</button>
            <button class="quick-btn" data-action="get_viewport">Viewport</button>
            <button class="quick-btn" data-action="get_doc_info">Doc Info</button>
            <button class="quick-btn" data-action="list_components">Components</button>
            <button class="quick-btn" data-action="get_local_styles">Styles</button>
            <button class="quick-btn" data-action="get_fonts">Fonts</button>
            <button class="quick-btn" data-action="get_layer_list">Layers</button>
            <button class="quick-btn" data-action="get_variables">Variables</button>
            <button class="quick-btn" data-action="export_tokens">Tokens</button>
          </div>
        </div>
      </div>

      <!-- Command History -->
      <div class="section" id="historySection" style="display:none;">
        <div class="section-header" id="historyHeader">
          <span class="section-left">
            <span>üìú History</span>
            <span class="badge" id="historyCount">0</span>
          </span>
          <div class="section-actions">
            <span class="section-action" id="clearHistory" title="Clear">‚úï</span>
            <span class="section-action" id="toggleHistory">‚ñº</span>
          </div>
        </div>
        <div class="section-content" id="historyContent">
          <div class="history-content" id="historyData">
            <div class="empty-state">No commands yet</div>
          </div>
        </div>
      </div>

      <!-- Design Tokens -->
      <div class="section" id="tokensSection" style="display:none;">
        <div class="section-header" id="tokensHeader">
          <span class="section-left">
            <span>üé® Tokens</span>
            <span class="badge" id="tokenCount">0</span>
          </span>
          <div class="section-actions">
            <span class="section-action" id="exportTokens" title="Export">‚Üó</span>
            <span class="section-action" id="toggleTokens">‚ñº</span>
          </div>
        </div>
        <div class="section-content" id="tokensContent">
          <div class="token-grid" id="tokenGrid">
            <div class="empty-state" style="grid-column: 1/-1;">Extract tokens from styles</div>
          </div>
        </div>
      </div>

      <!-- Multi-Platform Generation -->
      <div class="section" id="multiPlatformSection" style="display:none;">
        <div class="section-header" id="multiPlatformHeader">
          <span class="section-left">
            <span>üåê Multi-Platform</span>
          </span>
          <div class="section-actions">
            <span class="section-action" id="toggleMultiPlatform">‚ñº</span>
          </div>
        </div>
        <div class="section-content" id="multiPlatformContent">
          <div style="padding: 8px;">
            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;">
              <label style="display: flex; align-items: center; gap: 4px; margin: 0;">
                <input type="checkbox" id="mpReact" checked> React
              </label>
              <label style="display: flex; align-items: center; gap: 4px; margin: 0;">
                <input type="checkbox" id="mpSwiftUI" checked> SwiftUI
              </label>
              <label style="display: flex; align-items: center; gap: 4px; margin: 0;">
                <input type="checkbox" id="mpCompose" checked> Compose
              </label>
              <label style="display: flex; align-items: center; gap: 4px; margin: 0;">
                <input type="checkbox" id="mpFlutter"> Flutter
              </label>
            </div>
            <button class="btn btn-primary" id="generateMultiBtn" style="width: 100%;">üöÄ Generate All Platforms</button>
            <div id="multiPlatformResults" style="margin-top: 8px;"></div>
          </div>
        </div>
      </div>

      <!-- Vision Compare (SSIM) -->
      <div class="section" id="visionSection" style="display:none;">
        <div class="section-header" id="visionHeader">
          <span class="section-left">
            <span>üëÅÔ∏è Vision Compare</span>
            <span class="badge" id="ssimScore">-</span>
          </span>
          <div class="section-actions">
            <span class="section-action" id="toggleVision">‚ñº</span>
          </div>
        </div>
        <div class="section-content" id="visionContent">
          <div style="padding: 8px;">
            <div style="margin-bottom: 8px;">
              <label>Reference Image (Figma Export)</label>
              <input type="text" id="referenceImagePath" placeholder="/path/to/reference.png" style="width: 100%;">
            </div>
            <div style="margin-bottom: 8px;">
              <label>Threshold</label>
              <input type="range" id="ssimThreshold" min="0.8" max="1.0" step="0.01" value="0.95" style="width: 100%;">
              <span id="thresholdValue">0.95</span>
            </div>
            <button class="btn btn-primary" id="compareVisionBtn" style="width: 100%;">üîç Compare with Generated Code</button>
            <div id="visionResult" style="margin-top: 8px;"></div>
          </div>
        </div>
      </div>

      <!-- Storybook Generation -->
      <div class="section" id="storybookSection" style="display:none;">
        <div class="section-header" id="storybookHeader">
          <span class="section-left">
            <span>üìñ Storybook</span>
          </span>
          <div class="section-actions">
            <span class="section-action" id="toggleStorybook">‚ñº</span>
          </div>
        </div>
        <div class="section-content" id="storybookContent">
          <div style="padding: 8px;">
            <div style="margin-bottom: 8px;">
              <label>Figma URL</label>
              <input type="text" id="figmaUrlInput" placeholder="https://www.figma.com/design/..." style="width: 100%;">
            </div>
            <div style="margin-bottom: 8px;">
              <label>Framework</label>
              <select id="storyFramework" style="width: 100%;">
                <option value="react">React</option>
                <option value="vue">Vue</option>
              </select>
            </div>
            <button class="btn btn-primary" id="generateStoryBtn" style="width: 100%;">üìñ Generate Story</button>
            <div id="storybookResult" style="margin-top: 8px;"></div>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="section">
        <div class="section-header" id="logHeader">
          <span class="section-left">
            <span>üìã Log</span>
            <span class="badge" id="logBadge">0</span>
          </span>
          <div class="section-actions">
            <div class="filter-btns">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="ok">OK</button>
              <button class="filter-btn" data-filter="err">Err</button>
            </div>
            <span class="section-action" id="exportLogs" title="Export">‚Üó</span>
            <span class="section-action" id="logClear" title="Clear">‚úï</span>
            <span class="section-action" id="toggleLog">‚ñº</span>
          </div>
        </div>
        <div class="section-content" id="logWrapper">
          <div class="log-content" id="logContent">
            <div class="empty-state">Waiting for connection...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // DOM refs
      var $ = function(id) { return document.getElementById(id); };
      var serverInput = $("server"), channelInput = $("channel"), copyChannelBtn = $("copyChannel");
      var connectBtn = $("connect"), connectText = $("connectText"), connectSpinner = $("connectSpinner");
      var disconnectBtn = $("disconnect"), selfTestBtn = $("selfTest");
      var statusDot = $("statusDot"), statusText = $("statusText"), pingDisplay = $("pingDisplay");
      var cmdCount = $("cmdCount"), okCount = $("okCount"), errCount = $("errCount"), avgPingEl = $("avgPing");
      var sessionBar = $("sessionBar"), sessionDuration = $("sessionDuration");
      var successRate = $("successRate"), cmdPerMin = $("cmdPerMin");
      var autoReconnectToggle = $("autoReconnect");
      var testProgress = $("testProgress"), testName = $("testName"), testCount = $("testCount"), testBar = $("testBar");
      var logContent = $("logContent"), logWrapper = $("logWrapper"), logBadge = $("logBadge");
      var inspectorData = $("inspectorData"), selectionCountBadge = $("selectionCount");
      var analyzeBtn = $("analyzeBtn"), insightsPanel = $("insightsPanel"), insightsData = $("insightsData");
      var implementBtn = $("implementBtn"), codegenPanel = $("codegenPanel"), platformSelect = $("platformSelect");
      var codegenStatus = $("codegenStatus"), codegenOutput = $("codegenOutput");
      var copyCodeBtn = $("copyCodeBtn"), stopGenBtn = $("stopGenBtn"), applyToFigmaBtn = $("applyToFigmaBtn");
      var historyData = $("historyData"), historyCountBadge = $("historyCount");
      var tokenGrid = $("tokenGrid"), tokenCountBadge = $("tokenCount");
      var quickSection = $("quickSection"), historySection = $("historySection"), tokensSection = $("tokensSection");

      // State
      var STORAGE_KEY = "figmaMcpBridgeState";
      var serverUrl = "", channelId = "", polling = false;
      var stats = { cmd: 0, ok: 0, err: 0 };
      var logs = [], cmdHistory = [], tokens = [];
      var MAX_LOGS = 100, MAX_HISTORY = 20;
      var sessionStart = null, sessionTimer = null;
      var currentFilter = "all";
      var pings = [], reconnectAttempts = 0, MAX_RECONNECT = 5;
      var autoReconnect = true;
      var lastSelection = null;
      var isAnalyzing = false;
      var isGenerating = false;
      var currentEventSource = null;  // For SSE streaming
      var generatedCode = "";

      // Utility
      function normalizeUrl(raw) {
        if (!raw) return "";
        var v = raw.trim();
        if (!v) return "";
        if (!/^https?:\/\//i.test(v)) v = "http://" + v;
        if (v.charAt(v.length - 1) === "/") v = v.slice(0, -1);
        return v;
      }
      function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e) { return {}; } }
      function saveState(s) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); } catch(e) {} }
      function escapeHtml(s) { return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
      function truncate(s, n) { return s.length > n ? s.substring(0, n-3) + "..." : s; }
      function timeStr() {
        var d = new Date();
        return String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0") + ":" + String(d.getSeconds()).padStart(2,"0");
      }

      // Status
      function setStatus(st, txt) {
        statusDot.className = "status-dot " + st;
        statusText.textContent = txt || st.charAt(0).toUpperCase() + st.slice(1);
      }

      // Stats
      function updateStats() {
        cmdCount.textContent = stats.cmd;
        okCount.textContent = stats.ok;
        errCount.textContent = stats.err;
        var total = stats.ok + stats.err;
        if (total > 0) {
          var rate = Math.round((stats.ok / total) * 100);
          successRate.textContent = rate + "%";
          successRate.style.color = rate >= 90 ? "var(--success)" : rate >= 70 ? "var(--warning)" : "var(--error)";
        }
        if (pings.length > 0) {
          var avg = Math.round(pings.reduce(function(a,b){return a+b;},0) / pings.length);
          avgPingEl.textContent = avg + "ms";
        }
        if (sessionStart) {
          var mins = (Date.now() - sessionStart) / 60000;
          cmdPerMin.textContent = mins > 0 ? Math.round(stats.cmd / mins) : 0;
        }
      }

      function updatePing(ms) {
        pings.push(ms);
        if (pings.length > 20) pings.shift();
        pingDisplay.style.display = "inline";
        pingDisplay.textContent = ms + "ms";
        pingDisplay.className = "ping " + (ms < 100 ? "good" : ms < 500 ? "slow" : "bad");
        updateStats();
      }

      function updateSessionDuration() {
        if (!sessionStart) return;
        var elapsed = Math.floor((Date.now() - sessionStart) / 1000);
        var m = Math.floor(elapsed / 60), s = elapsed % 60;
        sessionDuration.textContent = m + ":" + String(s).padStart(2, "0");
      }

      // Logs
      function addLog(action, result, isOk) {
        logs.unshift({ time: timeStr(), action: action, result: result, ok: isOk });
        if (logs.length > MAX_LOGS) logs.pop();
        logBadge.textContent = logs.length;
        renderLogs();
      }

      function renderLogs() {
        var filtered = logs;
        if (currentFilter === "ok") filtered = logs.filter(function(l) { return l.ok; });
        else if (currentFilter === "err") filtered = logs.filter(function(l) { return !l.ok; });
        if (filtered.length === 0) {
          logContent.innerHTML = '<div class="empty-state">' + (logs.length === 0 ? "No activity" : "No matches") + '</div>';
          return;
        }
        logContent.innerHTML = filtered.map(function(l) {
          return '<div class="log-entry"><span class="log-time">' + l.time + '</span><span class="log-action">' +
            escapeHtml(l.action) + '</span><span class="log-result ' + (l.ok ? "ok" : "error") + '" title="' +
            escapeHtml(l.result) + '">' + escapeHtml(truncate(l.result, 40)) + '</span></div>';
        }).join("");
      }

      // History
      function addHistory(action, payload) {
        cmdHistory.unshift({ action: action, payload: payload, time: timeStr() });
        if (cmdHistory.length > MAX_HISTORY) cmdHistory.pop();
        historyCountBadge.textContent = cmdHistory.length;
        renderHistory();
      }

      function renderHistory() {
        if (cmdHistory.length === 0) {
          historyData.innerHTML = '<div class="empty-state">No commands yet</div>';
          return;
        }
        historyData.innerHTML = cmdHistory.map(function(h, i) {
          return '<div class="history-entry"><span class="log-time">' + h.time + '</span><span class="log-action">' +
            h.action + '</span><button class="btn-sm btn-secondary" data-replay="' + i + '">‚ñ∂</button></div>';
        }).join("");
      }

      // Inspector
      function updateInspector(sel) {
        lastSelection = sel;
        selectionCountBadge.textContent = sel ? sel.count : 0;
        // Enable/disable analyze and implement buttons
        var hasSelection = sel && sel.count > 0;
        analyzeBtn.disabled = !hasSelection || isAnalyzing;
        implementBtn.disabled = !hasSelection || isGenerating;
        if (!hasSelection) {
          inspectorData.innerHTML = '<div class="empty-state">Select something in Figma</div>';
          insightsPanel.style.display = "none";
          codegenPanel.style.display = "none";
          return;
        }
        var n = sel.nodes[0];
        var rows = [
          { k: "Name", v: n.name || "(unnamed)" },
          { k: "Type", v: n.type },
          { k: "ID", v: truncate(n.id, 20) },
          { k: "Size", v: Math.round(n.width) + " √ó " + Math.round(n.height) },
          { k: "Position", v: Math.round(n.x) + ", " + Math.round(n.y) }
        ];
        // Handle fills (now array of objects)
        if (n.fills && Array.isArray(n.fills)) {
          var fillStr = n.fills.map(function(f) {
            return f.color || f.type;
          }).join(", ");
          rows.push({ k: "Fills", v: fillStr || n.fills.length + " fill(s)" });
        }
        if (n.opacity !== undefined && n.opacity < 1) rows.push({ k: "Opacity", v: Math.round(n.opacity * 100) + "%" });
        if (n.cornerRadius) rows.push({ k: "Radius", v: n.cornerRadius + "px" });
        if (n.autoLayout) rows.push({ k: "Layout", v: n.autoLayout.mode + " (" + n.autoLayout.spacing + "px)" });
        if (n.text) rows.push({ k: "Text", v: truncate(n.text.characters, 30) });
        if (n.children) rows.push({ k: "Children", v: n.children.length + " layer(s)" });
        inspectorData.innerHTML = rows.map(function(r) {
          return '<div class="inspector-row"><span class="inspector-key">' + r.k + '</span><span class="inspector-value">' + escapeHtml(String(r.v)) + '</span></div>';
        }).join("");
      }

      // LLM Analysis
      function analyzeSelection() {
        if (!lastSelection || lastSelection.count === 0 || isAnalyzing) return;
        isAnalyzing = true;
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "‚è≥ Analyzing...";
        insightsPanel.style.display = "block";
        insightsData.innerHTML = '<div style="text-align:center;color:var(--text-secondary);">Analyzing design...</div>';

        var node = lastSelection.nodes[0];
        var analysisPrompt = buildAnalysisPrompt(node);

        // Check if serverUrl is set
        if (!serverUrl) {
          addLog("analyze", "No server URL - please connect first", false);
          analysisStatus.textContent = "Not connected to server";
          isAnalyzing = false;
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "üîç Analyze";
          return;
        }

        // Call LLM via server endpoint
        fetch(serverUrl + "/plugin/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ channel_id: channelId, node: node, prompt: analysisPrompt })
        }).then(function(r) {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(d) {
          displayInsights(d.insights || d.response || "No insights available");
        }).catch(function(e) {
          // Fallback: generate local heuristic insights
          displayInsights(generateLocalInsights(node));
          addLog("analyze", "Using local heuristics: " + e.message, true);
        }).finally(function() {
          isAnalyzing = false;
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "üß† Analyze";
        });
      }

      function buildAnalysisPrompt(node) {
        return "Analyze this Figma design element and provide brief insights:\n" +
          "- Name: " + node.name + "\n" +
          "- Type: " + node.type + "\n" +
          "- Size: " + Math.round(node.width) + "x" + Math.round(node.height) + "px\n" +
          "- Position: (" + Math.round(node.x) + ", " + Math.round(node.y) + ")\n" +
          (node.fills ? "- Fills: " + node.fills + "\n" : "") +
          "\nProvide 3-4 bullet points about: naming convention, touch target size (44px iOS/48px Android), auto-layout usage, accessibility considerations.";
      }

      function generateLocalInsights(node) {
        var insights = [];
        var w = node.width, h = node.height;

        // Touch target check
        if ((node.type === "FRAME" || node.type === "COMPONENT" || node.type === "INSTANCE") &&
            (node.name.toLowerCase().includes("button") || node.name.toLowerCase().includes("btn"))) {
          if (w >= 44 && h >= 44) {
            insights.push({ type: "pass", text: "Touch target " + Math.round(w) + "√ó" + Math.round(h) + "px - iOS HIG OK" });
          } else {
            insights.push({ type: "warn", text: "Touch target " + Math.round(w) + "√ó" + Math.round(h) + "px - Consider 44√ó44px min" });
          }
        }

        // Naming convention
        var nameParts = node.name.split(/[_\-\/]/);
        if (nameParts.length > 1 && /^[A-Z]/.test(nameParts[0])) {
          insights.push({ type: "pass", text: "Naming: PascalCase with separator - Good" });
        } else if (node.name.includes(" ")) {
          insights.push({ type: "warn", text: "Naming: Contains spaces - Use underscore/hyphen" });
        } else {
          insights.push({ type: "pass", text: "Naming: " + truncate(node.name, 20) + " - OK" });
        }

        // Auto-layout hint
        if (node.type === "FRAME") {
          insights.push({ type: "info", text: "Frame detected - Consider Auto Layout for responsiveness" });
        }

        // Size checks
        if (w > 1440) {
          insights.push({ type: "warn", text: "Width " + Math.round(w) + "px > 1440px - May overflow desktop" });
        }
        if (h > 900 && node.type === "FRAME") {
          insights.push({ type: "info", text: "Height " + Math.round(h) + "px - Consider scrollable content" });
        }

        if (insights.length === 0) {
          insights.push({ type: "pass", text: "Basic checks passed" });
        }

        return insights;
      }

      function displayInsights(insights) {
        if (typeof insights === "string") {
          // Parse LLM text response
          insightsData.innerHTML = '<div class="insight-item"><span style="white-space:pre-wrap;">' + escapeHtml(insights) + '</span></div>';
          return;
        }
        // Array of insight objects
        insightsData.innerHTML = insights.map(function(i) {
          var cls = i.type === "pass" ? "insight-pass" : (i.type === "warn" ? "insight-warn" : (i.type === "fail" ? "insight-fail" : (i.type === "info" ? "insight-info" : "")));
          var icon = i.type === "pass" ? "‚úì" : (i.type === "warn" ? "‚ö†" : (i.type === "fail" ? "‚úó" : (i.type === "info" ? "‚Ñπ" : "‚Ä¢")));
          return '<div class="insight-item ' + cls + '"><span>' + icon + '</span><span>' + escapeHtml(i.text) + '</span></div>';
        }).join("");
      }

      // Code Generation
      function implementSelection() {
        if (!lastSelection || lastSelection.count === 0 || isGenerating) return;
        isGenerating = true;
        implementBtn.disabled = true;
        implementBtn.textContent = "‚è≥ Generating...";
        codegenPanel.style.display = "block";
        codegenStatus.className = "codegen-status streaming";
        codegenStatus.textContent = "Connecting to LLM...";
        codegenOutput.textContent = "";
        generatedCode = "";
        copyCodeBtn.disabled = true;
        stopGenBtn.style.display = "inline-flex";

        var node = lastSelection.nodes[0];
        var platform = platformSelect.value;
        var prompt = buildCodegenPrompt(node, platform);

        // Direct fetch (SSE streaming can be added later)
        tryRegularCodegen(node, platform, prompt);
      }

      function tryRegularCodegen(node, platform, prompt) {
        codegenStatus.textContent = "Queuing request for AI agent...";

        // Debug: check if serverUrl is set
        if (!serverUrl) {
          addLog("codegen", "No server URL - using local templates", false);
          codegenStatus.textContent = "No server - using local templates...";
          generatedCode = generateLocalCode(node, platform);
          codegenOutput.textContent = generatedCode;
          finishCodegen(true);
          return;
        }

        // Direct inline Ollama call via figma-mcp (simpler, no external agent needed)
        codegenStatus.textContent = "Calling Ollama via figma-mcp...";
        fetch(serverUrl + "/plugin/codegen", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ node: node, platform: platform, prompt: prompt })
        }).then(function(r) {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(d) {
          generatedCode = d.code || "";
          codegenOutput.textContent = generatedCode;
          finishCodegen(true);
          var source = d.source || "unknown";
          addLog("codegen", "Generated via " + source, true);
        }).catch(function(e) {
          // Fallback: local template generation
          codegenStatus.textContent = "Using local templates...";
          generatedCode = generateLocalCode(node, platform);
          codegenOutput.textContent = generatedCode;
          finishCodegen(true);
          addLog("codegen", "Local fallback: " + e.message, true);
        });
      }

      function stopCodegen() {
        if (currentEventSource) {
          currentEventSource.close();
          currentEventSource = null;
        }
        finishCodegen(false);
        codegenStatus.textContent = "Stopped";
      }

      function finishCodegen(success) {
        isGenerating = false;
        implementBtn.disabled = false;
        implementBtn.textContent = "üöÄ Implement";
        stopGenBtn.style.display = "none";
        codegenStatus.className = "codegen-status";
        codegenStatus.textContent = success ? "Complete ‚úì" : "Stopped";
        copyCodeBtn.disabled = !generatedCode;
        applyToFigmaBtn.disabled = !generatedCode;
        if (success && generatedCode) {
          addLog("codegen", platformSelect.value + " code generated", true);
        }
      }

      function buildCodegenPrompt(node, platform) {
        var platformNames = {
          react: "React with TypeScript (TSX)",
          swiftui: "SwiftUI",
          compose: "Jetpack Compose (Kotlin)",
          flutter: "Flutter (Dart)",
          html: "HTML with CSS"
        };
        return "Convert this Figma design to " + platformNames[platform] + " code:\n\n" +
          "Node: " + node.name + "\n" +
          "Type: " + node.type + "\n" +
          "Size: " + Math.round(node.width) + " x " + Math.round(node.height) + "px\n" +
          "Position: (" + Math.round(node.x) + ", " + Math.round(node.y) + ")\n" +
          (node.fills ? "Fills: " + node.fills + "\n" : "") +
          (node.opacity !== undefined ? "Opacity: " + Math.round(node.opacity * 100) + "%\n" : "") +
          "\nGenerate clean, production-ready code with proper styling.";
      }

      function generateLocalCode(node, platform) {
        var name = node.name.replace(/[^a-zA-Z0-9]/g, "_");
        if (/^[0-9]/.test(name)) name = "_" + name;
        var w = Math.round(node.width), h = Math.round(node.height);

        // Extract background color
        var bgColor = null;
        if (node.fills && Array.isArray(node.fills) && node.fills.length > 0) {
          var firstFill = node.fills[0];
          if (firstFill.color) bgColor = firstFill.color;
        }

        // Extract children info for structure
        var childrenCode = "";
        var childrenComments = "";
        if (node.children && node.children.length > 0) {
          childrenComments = "\n  // Children (" + node.children.length + "):\n";
          node.children.slice(0, 10).forEach(function(child, i) {
            var childName = child.name || "Layer " + i;
            var childType = child.type || "UNKNOWN";
            childrenComments += "  // - " + childName + " (" + childType + ")\n";
          });
          if (node.children.length > 10) {
            childrenComments += "  // ... and " + (node.children.length - 10) + " more\n";
          }
        }

        // Auto-layout info
        var layoutComment = "";
        if (node.autoLayout) {
          layoutComment = "\n  // Layout: " + node.autoLayout.mode + ", spacing: " + node.autoLayout.spacing + "px\n";
        }

        switch (platform) {
          case "react":
            var reactBg = bgColor ? "backgroundColor: '" + bgColor + "'," : "";
            var reactFlex = node.autoLayout ? "display: 'flex', flexDirection: '" + (node.autoLayout.mode === "HORIZONTAL" ? "row" : "column") + "', gap: " + node.autoLayout.spacing + "," : "";
            return "import React from 'react';\n\n" +
              "interface " + name + "Props {\n  className?: string;\n}\n" + childrenComments + layoutComment + "\n" +
              "export const " + name + ": React.FC<" + name + "Props> = ({ className }) => {\n" +
              "  return (\n    <div\n      className={className}\n      style={{\n" +
              "        width: " + w + ",\n        height: " + h + ",\n" +
              (reactBg ? "        " + reactBg + "\n" : "") +
              (reactFlex ? "        " + reactFlex + "\n" : "") +
              "      }}\n    >\n" +
              "      {/* TODO: Add " + (node.children ? node.children.length : 0) + " child components */}\n" +
              "    </div>\n  );\n};\n";

          case "swiftui":
            var swiftBg = bgColor ? "\n            .background(Color(hex: \"" + bgColor + "\"))" : "";
            var swiftStack = node.autoLayout ? (node.autoLayout.mode === "HORIZONTAL" ? "HStack(spacing: " + node.autoLayout.spacing + ")" : "VStack(spacing: " + node.autoLayout.spacing + ")") : "ZStack";
            return "import SwiftUI\n" + childrenComments + layoutComment + "\n" +
              "struct " + name + ": View {\n" +
              "    var body: some View {\n" +
              "        " + swiftStack + " {\n" +
              "            // TODO: Add " + (node.children ? node.children.length : 0) + " child views\n" +
              "        }\n" +
              "        .frame(width: " + w + ", height: " + h + ")" + swiftBg + "\n" +
              "    }\n}\n\n#Preview {\n    " + name + "()\n}\n";

          case "compose":
            var composeBg = bgColor ? "\n            .background(Color(0xFF" + bgColor.replace("#", "").toUpperCase() + "))" : "";
            var composeLayout = node.autoLayout ? (node.autoLayout.mode === "HORIZONTAL" ? "Row(horizontalArrangement = Arrangement.spacedBy(" + node.autoLayout.spacing + ".dp))" : "Column(verticalArrangement = Arrangement.spacedBy(" + node.autoLayout.spacing + ".dp))") : "Box";
            return "import androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.background\nimport androidx.compose.runtime.Composable\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.unit.dp\n" + childrenComments + layoutComment + "\n" +
              "@Composable\nfun " + name + "(\n    modifier: Modifier = Modifier\n) {\n" +
              "    " + composeLayout + " {\n" +
              "        modifier = modifier\n" +
              "            .width(" + w + ".dp)\n            .height(" + h + ".dp)" + composeBg + "\n" +
              "        // TODO: Add " + (node.children ? node.children.length : 0) + " child composables\n" +
              "    }\n}\n";

          case "flutter":
            var flutterBg = bgColor ? "color: Color(0xFF" + bgColor.replace("#", "").toUpperCase() + ")," : "";
            var flutterLayout = node.autoLayout ? (node.autoLayout.mode === "HORIZONTAL" ? "Row" : "Column") : "Stack";
            return "import 'package:flutter/material.dart';\n" + childrenComments.replace(/\/\//g, "//") + layoutComment.replace(/\/\//g, "//") + "\n" +
              "class " + name + " extends StatelessWidget {\n" +
              "  const " + name + "({super.key});\n\n" +
              "  @override\n  Widget build(BuildContext context) {\n" +
              "    return Container(\n" +
              "      width: " + w + ",\n      height: " + h + ",\n" +
              (flutterBg ? "      " + flutterBg + "\n" : "") +
              "      child: " + flutterLayout + "(\n" +
              "        children: [\n" +
              "          // TODO: Add " + (node.children ? node.children.length : 0) + " child widgets\n" +
              "        ],\n" +
              "      ),\n    );\n  }\n}\n";

          case "html":
          default:
            var htmlBg = bgColor ? "background-color: " + bgColor + ";" : "";
            var htmlFlex = node.autoLayout ? "display: flex; flex-direction: " + (node.autoLayout.mode === "HORIZONTAL" ? "row" : "column") + "; gap: " + node.autoLayout.spacing + "px;" : "";
            return "<!-- " + node.name + " -->" + childrenComments.replace(/\/\//g, "<!--").replace(/\n/g, " -->\n<!-- ") + "\n" +
              "<div class=\"" + name.toLowerCase() + "\">\n" +
              "  <!-- TODO: Add " + (node.children ? node.children.length : 0) + " child elements -->\n" +
              "</div>\n\n" +
              "<style>\n." + name.toLowerCase() + " {\n" +
              "  width: " + w + "px;\n  height: " + h + "px;\n" +
              (htmlBg ? "  " + htmlBg + "\n" : "") +
              (htmlFlex ? "  " + htmlFlex + "\n" : "") +
              "}\n</style>\n";
        }
      }

      // Tokens
      function updateTokens(t) {
        tokens = t || [];
        tokenCountBadge.textContent = tokens.length;
        if (tokens.length === 0) {
          tokenGrid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;">No tokens</div>';
          return;
        }
        tokenGrid.innerHTML = tokens.slice(0, 18).map(function(c) {
          return '<div class="token-swatch" style="background:' + c + ';" data-color="' + c + '"></div>';
        }).join("");
      }

      // Connected state
      function setConnected(connected) {
        connectBtn.style.display = connected ? "none" : "flex";
        disconnectBtn.style.display = connected ? "flex" : "none";
        selfTestBtn.disabled = !connected;
        copyChannelBtn.disabled = !connected;
        serverInput.disabled = connected;
        channelInput.disabled = connected;
        quickSection.style.display = connected ? "block" : "none";
        historySection.style.display = connected ? "block" : "none";
        tokensSection.style.display = connected ? "block" : "none";
        if (typeof multiPlatformSection !== "undefined") multiPlatformSection.style.display = connected ? "block" : "none";
        if (typeof visionSection !== "undefined") visionSection.style.display = connected ? "block" : "none";
        if (typeof storybookSection !== "undefined") storybookSection.style.display = connected ? "block" : "none";
        sessionBar.style.display = connected ? "flex" : "none";
        if (connected) {
          sessionStart = Date.now();
          sessionTimer = setInterval(updateSessionDuration, 1000);
          requestSelectionUpdate();
        } else {
          if (sessionTimer) clearInterval(sessionTimer);
          sessionTimer = null;
          sessionStart = null;
          pingDisplay.style.display = "none";
        }
      }

      function setConnecting(c) {
        connectText.textContent = c ? "Connecting" : "Connect";
        connectSpinner.style.display = c ? "inline-block" : "none";
        connectBtn.disabled = c;
      }

      // Request selection update from plugin
      function requestSelectionUpdate() {
        parent.postMessage({ pluginMessage: { type: "request_selection" } }, "*");
      }

      // Connect
      function connect() {
        serverUrl = normalizeUrl(serverInput.value);
        channelId = channelInput.value.trim();
        if (!serverUrl) { addLog("connect", "URL required", false); setStatus("error", "URL Required"); return Promise.reject(); }
        serverInput.value = serverUrl;
        setStatus("connecting", "Connecting...");
        setConnecting(true);
        var startTime = Date.now();
        var payload = channelId ? { channel_id: channelId } : {};
        return fetch(serverUrl + "/plugin/connect", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }).then(function(r) {
          updatePing(Date.now() - startTime);
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(d) {
          channelId = d.channel_id || channelId;
          channelInput.value = channelId;
          saveState({ serverUrl: serverUrl, channelId: channelId });
          setStatus("connected", "Connected");
          setConnected(true);
          setConnecting(false);
          reconnectAttempts = 0;
          addLog("connect", "Channel: " + channelId.slice(0, 8) + "...", true);
          if (!polling) { polling = true; pollLoop(); }
        }).catch(function(e) {
          setStatus("error", "Failed");
          setConnecting(false);
          addLog("connect", String(e), false);
        });
      }

      function disconnect() {
        polling = false;
        channelId = "";
        setStatus("", "Disconnected");
        setConnected(false);
        addLog("disconnect", "User disconnected", true);
      }

      function pollLoop() {
        if (!channelId || !polling) { polling = false; return; }
        setStatus("polling", "Listening...");
        var startTime = Date.now();
        fetch(serverUrl + "/plugin/poll", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ channel_id: channelId, max_commands: 5, wait_ms: 15000 })
        }).then(function(r) {
          updatePing(Date.now() - startTime);
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(d) {
          setStatus("connected", "Connected");
          reconnectAttempts = 0;
          var cmds = Array.isArray(d.commands) ? d.commands : [];
          for (var i = 0; i < cmds.length; i++) {
            var cmd = cmds[i];
            stats.cmd++; updateStats();
            addLog(cmd.name || "unknown", "executing...", true);
            addHistory(cmd.name, cmd.payload);
            parent.postMessage({ pluginMessage: { type: "command", command: cmd } }, "*");
          }
          if (polling) setTimeout(pollLoop, 50);
        }).catch(function(e) {
          reconnectAttempts++;
          var delay = Math.min(2000 * reconnectAttempts, 10000);
          if (autoReconnect && reconnectAttempts < MAX_RECONNECT) {
            setStatus("error", "Retry " + reconnectAttempts + "/" + MAX_RECONNECT);
            addLog("poll", String(e), false);
            if (polling) setTimeout(pollLoop, delay);
          } else {
            polling = false;
            setStatus("error", "Disconnected");
            setConnected(false);
            addLog("disconnect", autoReconnect ? "Max retries" : "Connection lost", false);
          }
        });
      }

      // Message handler
      window.onmessage = function(ev) {
        var msg = ev.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "command_result") {
          if (!channelId) return;
          var payload = msg.payload;
          if (typeof msg.payload_json === "string") {
            try { payload = JSON.parse(msg.payload_json); } catch(e) { payload = { error: "Parse error" }; }
          }
          if (msg.ok) stats.ok++; else stats.err++;
          updateStats();
          addLog(msg.action || "result", msg.ok ? "OK" : (payload && payload.error ? payload.error : "Error"), msg.ok);
          fetch(serverUrl + "/plugin/result", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ channel_id: channelId, command_id: msg.command_id, ok: msg.ok, payload: payload })
          });
        }

        if (msg.type === "selection_update") {
          updateInspector(msg.selection);
        }

        if (msg.type === "tokens_update") {
          updateTokens(msg.tokens);
        }
      };

      // Event handlers
      connectBtn.onclick = function() { connect(); };
      disconnectBtn.onclick = disconnect;
      serverInput.onkeydown = function(e) { if (e.key === "Enter" && !connectBtn.disabled) connect(); };
      copyChannelBtn.onclick = function() {
        if (channelId) navigator.clipboard.writeText(channelId).then(function() { addLog("copy", "Copied", true); });
      };

      autoReconnectToggle.onclick = function() {
        autoReconnect = !autoReconnect;
        autoReconnectToggle.className = "toggle" + (autoReconnect ? " on" : "");
      };

      // Analyze button
      analyzeBtn.onclick = function() { analyzeSelection(); };

      // Code generation buttons
      implementBtn.onclick = function() { implementSelection(); };
      copyCodeBtn.onclick = function() {
        if (generatedCode) {
          navigator.clipboard.writeText(generatedCode).then(function() {
            addLog("copy", "Code copied!", true);
            copyCodeBtn.textContent = "‚úì Copied";
            setTimeout(function() { copyCodeBtn.textContent = "üìã Copy"; }, 1500);
          });
        }
      };
      stopGenBtn.onclick = function() { stopCodegen(); };

      // Apply generated code to Figma (Code ‚Üí Figma via LLM)
      applyToFigmaBtn.onclick = function() {
        if (!generatedCode || !channelId) return;
        applyToFigmaBtn.disabled = true;
        applyToFigmaBtn.textContent = "‚è≥ Converting...";
        addLog("apply", "Converting code to Figma DSL...", true);

        var nodeName = lastSelection && lastSelection.nodes[0] ? lastSelection.nodes[0].name + "_Generated" : "GeneratedComponent";

        // Step 1: Send code to server for DSL conversion
        if (!serverUrl) {
          addLog("apply", "No server - cannot convert code", false);
          applyToFigmaBtn.disabled = false;
          applyToFigmaBtn.textContent = "üé® Apply to Figma";
          return;
        }

        fetch(serverUrl + "/plugin/code-to-figma", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: generatedCode, name: nodeName })
        }).then(function(r) {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(d) {
          if (d.error) {
            addLog("apply", "Error: " + d.error, false);
            return;
          }

          var operations = d.operations || [];
          addLog("apply", "Got " + operations.length + " operations", true);
          applyToFigmaBtn.textContent = "‚è≥ Creating nodes...";

          // Step 2: Execute DSL in Figma
          var execCmd = {
            id: "exec-dsl-" + Date.now(),
            name: "execute_dsl",
            payload: { operations: operations }
          };
          parent.postMessage({ pluginMessage: { type: "command", command: execCmd } }, "*");
          addLog("apply", "Executing DSL in Figma", true);
          stats.cmd++; updateStats();

          setTimeout(function() {
            applyToFigmaBtn.disabled = false;
            applyToFigmaBtn.textContent = "üé® Apply to Figma";
          }, 1500);
        }).catch(function(e) {
          addLog("apply", "Failed: " + e.message, false);
          applyToFigmaBtn.disabled = false;
          applyToFigmaBtn.textContent = "üé® Apply to Figma";
        });
      };

      // Filters
      document.querySelectorAll(".filter-btn").forEach(function(b) {
        b.onclick = function(e) {
          e.stopPropagation();
          document.querySelectorAll(".filter-btn").forEach(function(x) { x.classList.remove("active"); });
          b.classList.add("active");
          currentFilter = b.getAttribute("data-filter");
          renderLogs();
        };
      });

      // Quick actions
      document.querySelectorAll(".quick-btn").forEach(function(b) {
        b.onclick = function() {
          var action = b.getAttribute("data-action");
          if (!channelId) return;
          var cmd = { id: "quick-" + Date.now(), name: action, payload: {} };
          parent.postMessage({ pluginMessage: { type: "command", command: cmd } }, "*");
          addLog(action, "executing...", true);
          addHistory(action, {});
          stats.cmd++; updateStats();
        };
      });

      // History replay
      historyData.onclick = function(e) {
        var btn = e.target.closest("[data-replay]");
        if (!btn || !channelId) return;
        var idx = parseInt(btn.getAttribute("data-replay"));
        var h = cmdHistory[idx];
        if (h) {
          var cmd = { id: "replay-" + Date.now(), name: h.action, payload: h.payload };
          parent.postMessage({ pluginMessage: { type: "command", command: cmd } }, "*");
          addLog(h.action, "replay...", true);
          stats.cmd++; updateStats();
        }
      };

      // Section toggles
      function setupToggle(toggleId, contentId) {
        var toggle = $(toggleId), content = $(contentId);
        if (toggle && content) {
          toggle.onclick = function(e) {
            e.stopPropagation();
            content.classList.toggle("collapsed");
            toggle.textContent = content.classList.contains("collapsed") ? "‚ñ∂" : "‚ñº";
          };
        }
      }
      setupToggle("toggleLog", "logWrapper");
      setupToggle("toggleQuick", "quickContent");
      setupToggle("toggleHistory", "historyContent");
      setupToggle("toggleInspector", "inspectorContent");
      setupToggle("toggleTokens", "tokensContent");

      // Clear buttons
      $("logClear").onclick = function(e) { e.stopPropagation(); logs = []; logBadge.textContent = "0"; renderLogs(); };
      $("clearHistory").onclick = function(e) { e.stopPropagation(); cmdHistory = []; historyCountBadge.textContent = "0"; renderHistory(); };

      // Export logs
      $("exportLogs").onclick = function(e) {
        e.stopPropagation();
        var data = logs.map(function(l) { return l.time + " | " + l.action + " | " + (l.ok ? "OK" : "ERR") + " | " + l.result; }).join("\n");
        var blob = new Blob([data], { type: "text/plain" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a"); a.href = url; a.download = "figma-mcp-logs.txt"; a.click();
        URL.revokeObjectURL(url);
        addLog("export", "Logs exported", true);
      };

      // Export tokens
      $("exportTokens").onclick = function(e) {
        e.stopPropagation();
        if (tokens.length === 0) return;
        var data = JSON.stringify({ colors: tokens }, null, 2);
        var blob = new Blob([data], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a"); a.href = url; a.download = "design-tokens.json"; a.click();
        URL.revokeObjectURL(url);
        addLog("export", "Tokens exported", true);
      };

      // Token swatches click to copy
      tokenGrid.onclick = function(e) {
        var swatch = e.target.closest(".token-swatch");
        if (swatch) {
          var color = swatch.getAttribute("data-color");
          navigator.clipboard.writeText(color).then(function() { addLog("copy", color, true); });
        }
      };

      // Self-test
      var SELF_TESTS = [
        { name: "list_pages", payload: {} },
        { name: "get_viewport", payload: {} },
        { name: "read_selection", payload: {} },
        { name: "get_doc_info", payload: {} },
        { name: "list_components", payload: {} },
        { name: "find_all", payload: { type: "FRAME" } },
        { name: "get_local_styles", payload: {} },
        { name: "get_fonts", payload: {} },
        { name: "get_layer_list", payload: {} },
        { name: "get_selection_colors", payload: {} }
      ];

      selfTestBtn.onclick = function() {
        if (!channelId) return;
        selfTestBtn.disabled = true;
        testProgress.style.display = "block";
        runSelfTests(0);
      };

      function runSelfTests(idx) {
        if (idx >= SELF_TESTS.length) {
          testProgress.style.display = "none";
          selfTestBtn.disabled = false;
          addLog("self-test", "Done " + SELF_TESTS.length + "/" + SELF_TESTS.length, true);
          return;
        }
        var test = SELF_TESTS[idx];
        testName.textContent = test.name;
        testCount.textContent = "(" + (idx + 1) + "/" + SELF_TESTS.length + ")";
        testBar.style.width = ((idx + 1) / SELF_TESTS.length * 100) + "%";
        var cmd = { id: "test-" + Date.now() + "-" + idx, name: test.name, payload: test.payload };
        parent.postMessage({ pluginMessage: { type: "command", command: cmd } }, "*");
        setTimeout(function() { runSelfTests(idx + 1); }, 300);
      }

      // Selection polling
      setInterval(function() { if (channelId) requestSelectionUpdate(); }, 2000);

      // ============== NEW FEATURES ==============

      // Multi-Platform Generation
      var multiPlatformSection = $("multiPlatformSection");
      var generateMultiBtn = $("generateMultiBtn");
      var multiPlatformResults = $("multiPlatformResults");

      generateMultiBtn.onclick = function() {
        if (!lastSelection || !lastSelection.nodes || !lastSelection.nodes[0]) {
          addLog("multi", "No selection", false);
          return;
        }
        var platforms = [];
        if ($("mpReact").checked) platforms.push("react");
        if ($("mpSwiftUI").checked) platforms.push("swiftui");
        if ($("mpCompose").checked) platforms.push("compose");
        if ($("mpFlutter").checked) platforms.push("flutter");

        if (platforms.length === 0) {
          addLog("multi", "Select at least one platform", false);
          return;
        }

        generateMultiBtn.disabled = true;
        generateMultiBtn.textContent = "‚è≥ Generating...";
        addLog("multi", "Generating for " + platforms.join(", "), true);

        fetch(serverUrl + "/plugin/codegen-multi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ node: lastSelection.nodes[0], platforms: platforms })
        }).then(function(r) {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(data) {
          var html = '<div style="font-size:10px;">';
          html += '<strong>' + data.componentName + '</strong> - ' + platforms.length + ' platforms<br>';
          platforms.forEach(function(p) {
            html += '<details style="margin-top:4px;"><summary style="cursor:pointer;">' + p.toUpperCase() + '</summary>';
            html += '<pre style="font-size:9px;background:var(--bg-secondary);padding:4px;overflow-x:auto;max-height:150px;">' + (data.code[p] || "N/A").replace(/</g, "&lt;") + '</pre></details>';
          });
          html += '</div>';
          multiPlatformResults.innerHTML = html;
          addLog("multi", "Generated " + platforms.length + " platforms", true);
        }).catch(function(e) {
          addLog("multi", "Error: " + e.message, false);
          multiPlatformResults.innerHTML = '<div style="color:var(--error);">Error: ' + e.message + '</div>';
        }).finally(function() {
          generateMultiBtn.disabled = false;
          generateMultiBtn.textContent = "üöÄ Generate All Platforms";
        });
      };

      // Vision Compare (SSIM)
      var visionSection = $("visionSection");
      var compareVisionBtn = $("compareVisionBtn");
      var ssimThreshold = $("ssimThreshold");
      var thresholdValue = $("thresholdValue");
      var ssimScoreBadge = $("ssimScore");
      var visionResult = $("visionResult");

      ssimThreshold.oninput = function() {
        thresholdValue.textContent = ssimThreshold.value;
      };

      compareVisionBtn.onclick = function() {
        var refPath = $("referenceImagePath").value.trim();
        if (!refPath) {
          addLog("vision", "Reference image path required", false);
          return;
        }
        if (!generatedCode) {
          addLog("vision", "Generate code first", false);
          return;
        }

        compareVisionBtn.disabled = true;
        compareVisionBtn.textContent = "‚è≥ Comparing...";
        addLog("vision", "Comparing with SSIM...", true);

        fetch(serverUrl + "/plugin/vision-compare", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            reference: refPath,
            code: generatedCode,
            threshold: parseFloat(ssimThreshold.value)
          })
        }).then(function(r) {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(data) {
          var ssim = data.ssim || 0;
          var pass = data.pass;
          ssimScoreBadge.textContent = (ssim * 100).toFixed(1) + "%";
          ssimScoreBadge.style.background = pass ? "var(--success)" : "var(--error)";
          ssimScoreBadge.style.color = "#fff";
          visionResult.innerHTML = '<div style="color:' + (pass ? "var(--success)" : "var(--error)") + ';">' +
            (pass ? "‚úì PASS" : "‚úó FAIL") + ' - SSIM: ' + (ssim * 100).toFixed(2) + '% (threshold: ' + (data.threshold * 100) + '%)</div>';
          addLog("vision", (pass ? "PASS" : "FAIL") + " SSIM=" + ssim.toFixed(3), pass);
        }).catch(function(e) {
          addLog("vision", "Error: " + e.message, false);
          visionResult.innerHTML = '<div style="color:var(--error);">Error: ' + e.message + '</div>';
        }).finally(function() {
          compareVisionBtn.disabled = false;
          compareVisionBtn.textContent = "üîç Compare with Generated Code";
        });
      };

      // Storybook Generation
      var storybookSection = $("storybookSection");
      var generateStoryBtn = $("generateStoryBtn");
      var storybookResult = $("storybookResult");

      generateStoryBtn.onclick = function() {
        if (!lastSelection || !lastSelection.nodes || !lastSelection.nodes[0]) {
          addLog("storybook", "No selection", false);
          return;
        }

        var figmaUrl = $("figmaUrlInput").value.trim();
        var framework = $("storyFramework").value;

        generateStoryBtn.disabled = true;
        generateStoryBtn.textContent = "‚è≥ Generating...";
        addLog("storybook", "Generating Storybook story...", true);

        fetch(serverUrl + "/plugin/generate-story", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            node: lastSelection.nodes[0],
            code: generatedCode || "",
            figmaUrl: figmaUrl,
            framework: framework
          })
        }).then(function(r) {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        }).then(function(data) {
          var html = '<div style="font-size:10px;">';
          html += '<strong>' + data.componentName + '</strong><br>';
          html += '<details style="margin-top:4px;"><summary style="cursor:pointer;">üìñ ' + data.storyFile + '</summary>';
          html += '<pre style="font-size:9px;background:var(--bg-secondary);padding:4px;overflow-x:auto;max-height:200px;">' + data.storyCode.replace(/</g, "&lt;") + '</pre></details>';
          html += '<details style="margin-top:4px;"><summary style="cursor:pointer;">üìÑ ' + data.componentFile + '</summary>';
          html += '<pre style="font-size:9px;background:var(--bg-secondary);padding:4px;overflow-x:auto;max-height:200px;">' + data.componentCode.replace(/</g, "&lt;") + '</pre></details>';
          html += '</div>';
          storybookResult.innerHTML = html;
          addLog("storybook", "Generated " + data.storyFile, true);
        }).catch(function(e) {
          addLog("storybook", "Error: " + e.message, false);
          storybookResult.innerHTML = '<div style="color:var(--error);">Error: ' + e.message + '</div>';
        }).finally(function() {
          generateStoryBtn.disabled = false;
          generateStoryBtn.textContent = "üìñ Generate Story";
        });
      };

      // Show new sections when connected
      function showNewSections(show) {
        multiPlatformSection.style.display = show ? "block" : "none";
        visionSection.style.display = show ? "block" : "none";
        storybookSection.style.display = show ? "block" : "none";
      }

      // Toggle handlers for new sections
      $("toggleMultiPlatform").onclick = function() {
        var content = $("multiPlatformContent");
        content.classList.toggle("collapsed");
        this.textContent = content.classList.contains("collapsed") ? "‚ñ∂" : "‚ñº";
      };
      $("toggleVision").onclick = function() {
        var content = $("visionContent");
        content.classList.toggle("collapsed");
        this.textContent = content.classList.contains("collapsed") ? "‚ñ∂" : "‚ñº";
      };
      $("toggleStorybook").onclick = function() {
        var content = $("storybookContent");
        content.classList.toggle("collapsed");
        this.textContent = content.classList.contains("collapsed") ? "‚ñ∂" : "‚ñº";
      };

      // ============== END NEW FEATURES ==============

      // Load saved state and auto-connect
      var state = loadState();
      if (state.serverUrl) serverInput.value = state.serverUrl;
      if (state.channelId) channelInput.value = state.channelId;

      // Auto-connect if we have a saved server URL
      if (state.serverUrl) {
        setTimeout(function() {
          addLog("init", "Auto-connecting to " + state.serverUrl, true);
          connect().catch(function() {
            addLog("init", "Auto-connect failed, manual connect required", false);
          });
        }, 500);
      }
    </script>
  </body>
</html>
