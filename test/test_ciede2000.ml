(** CIEDE2000 ê²€ì¦ í…ŒìŠ¤íŠ¸ - CIE Technical Report 142-2001 í…ŒìŠ¤íŠ¸ ë°ì´í„°

    ì´ í…ŒìŠ¤íŠ¸ëŠ” CIEì—ì„œ ê³µì‹ ë°œí‘œí•œ ê²€ì¦ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    ì¶œì²˜: Sharma, G., Wu, W., & Dalal, E. N. (2005).
          "The CIEDE2000 color-difference formula: Implementation notes"
          Color Research & Application, 30(1), 21-30.

    í…ŒìŠ¤íŠ¸ í†µê³¼ = êµ­ì œ í‘œì¤€ ì¤€ìˆ˜ í™•ì¸
*)

open Figma_similarity

(** CIE ê³µì‹ í…ŒìŠ¤íŠ¸ ë°ì´í„° (Lab ê°’, ê¸°ëŒ€ Î”E) *)
let cie_test_data = [
  (* L1, a1, b1, L2, a2, b2, expected Î”E00 *)
  (* í…ŒìŠ¤íŠ¸ ìŒ 1-10: ê¸°ë³¸ ì¼€ì´ìŠ¤ *)
  (50.0, 2.6772, -79.7751, 50.0, 0.0, -82.7485, 2.0425);
  (50.0, 3.1571, -77.2803, 50.0, 0.0, -82.7485, 2.8615);
  (50.0, 2.8361, -74.0200, 50.0, 0.0, -82.7485, 3.4412);
  (50.0, -1.3802, -84.2814, 50.0, 0.0, -82.7485, 1.0000);
  (50.0, -1.1848, -84.8006, 50.0, 0.0, -82.7485, 1.0000);
  (50.0, -0.9009, -85.5211, 50.0, 0.0, -82.7485, 1.0000);
  (50.0, 0.0, 0.0, 50.0, -1.0, 2.0, 2.3669);
  (50.0, -1.0, 2.0, 50.0, 0.0, 0.0, 2.3669);
  (50.0, 2.49, -0.001, 50.0, -2.49, 0.0009, 7.1792);
  (50.0, 2.49, -0.001, 50.0, -2.49, 0.001, 7.1792);

  (* í…ŒìŠ¤íŠ¸ ìŒ 11-20: íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ *)
  (50.0, 2.49, -0.001, 50.0, -2.49, 0.0011, 7.2195);
  (50.0, 2.49, -0.001, 50.0, -2.49, 0.0012, 7.2195);
  (50.0, -0.001, 2.49, 50.0, 0.0009, -2.49, 4.8045);
  (50.0, -0.001, 2.49, 50.0, 0.001, -2.49, 4.8045);
  (50.0, -0.001, 2.49, 50.0, 0.0011, -2.49, 4.7461);
  (50.0, 2.5, 0.0, 50.0, 0.0, -2.5, 4.3065);
  (50.0, 2.5, 0.0, 73.0, 25.0, -18.0, 27.1492);
  (50.0, 2.5, 0.0, 61.0, -5.0, 29.0, 22.8977);
  (50.0, 2.5, 0.0, 56.0, -27.0, -3.0, 31.9030);
  (50.0, 2.5, 0.0, 58.0, 24.0, 15.0, 19.4535);

  (* í…ŒìŠ¤íŠ¸ ìŒ 21-34: ë°ê¸°/ì±„ë„/ìƒ‰ìƒ ë³€í™” *)
  (50.0, 2.5, 0.0, 50.0, 3.1736, 0.5854, 1.0000);
  (50.0, 2.5, 0.0, 50.0, 3.2972, 0.0, 1.0000);
  (50.0, 2.5, 0.0, 50.0, 1.8634, 0.5757, 1.0000);
  (50.0, 2.5, 0.0, 50.0, 3.2592, 0.335, 1.0000);
  (60.2574, -34.0099, 36.2677, 60.4626, -34.1751, 39.4387, 1.2644);
  (63.0109, -31.0961, -5.8663, 62.8187, -29.7946, -4.0864, 1.2630);
  (61.2901, 3.7196, -5.3901, 61.4292, 2.248, -4.962, 1.8731);
  (35.0831, -44.1164, 3.7933, 35.0232, -40.0716, 1.5901, 1.8645);
  (22.7233, 20.0904, -46.694, 23.0331, 14.973, -42.5619, 2.0373);
  (36.4612, 47.858, 18.3852, 36.2715, 50.5065, 21.2231, 1.4146);
  (90.8027, -2.0831, 1.441, 91.1528, -1.6435, 0.0447, 1.4441);
  (90.9257, -0.5406, -0.9208, 88.6381, -0.8985, -0.7239, 1.5381);
  (6.7747, -0.2908, -2.4247, 5.8714, -0.0985, -2.2286, 0.6377);
  (2.0776, 0.0795, -1.135, 0.9033, -0.0636, -0.5514, 0.9082);
]

(** í—ˆìš© ì˜¤ì°¨ (CIE ê¶Œì¥: 0.0001) *)
let tolerance = 0.001

(** ë‹¨ì¼ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‹¤í–‰ *)
let test_case (l1, a1, b1, l2, a2, b2, expected) =
  let actual = ciede2000 (l1, a1, b1) (l2, a2, b2) in
  let diff = Float.abs (actual -. expected) in
  let passed = diff < tolerance in
  (passed, actual, expected, diff)

(** ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ *)
let run_all_tests () =
  let results = List.mapi (fun i data ->
    let (passed, actual, expected, diff) = test_case data in
    (i + 1, passed, actual, expected, diff)
  ) cie_test_data in

  let passed_count = List.length (List.filter (fun (_, p, _, _, _) -> p) results) in
  let total = List.length results in

  Printf.printf "CIEDE2000 ê²€ì¦ í…ŒìŠ¤íŠ¸ (CIE TR 142-2001)\n";
  Printf.printf "========================================\n\n";

  List.iter (fun (i, passed, actual, expected, diff) ->
    let status = if passed then "âœ…" else "âŒ" in
    Printf.printf "%s Test %2d: expected=%.4f, actual=%.4f, diff=%.6f\n"
      status i expected actual diff
  ) results;

  Printf.printf "\n========================================\n";
  Printf.printf "ê²°ê³¼: %d/%d í†µê³¼ (%.1f%%)\n" passed_count total
    (100.0 *. float_of_int passed_count /. float_of_int total);

  if passed_count = total then begin
    Printf.printf "\nğŸ›ï¸ CIE êµ­ì œ í‘œì¤€ ì¤€ìˆ˜ í™•ì¸!\n";
    Printf.printf "   ì¶œì²˜: CIE Technical Report 142-2001\n";
    Printf.printf "   ì°¸ì¡°: Sharma et al. (2005), Color Research & Application\n"
  end else begin
    Printf.printf "\nâš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - êµ¬í˜„ ê²€í†  í•„ìš”\n"
  end;

  passed_count = total

let () =
  let success = run_all_tests () in
  exit (if success then 0 else 1)
